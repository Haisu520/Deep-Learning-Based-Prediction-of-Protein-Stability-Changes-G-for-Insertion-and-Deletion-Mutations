---
title: "Bioinformatics_Project_1"
author: "Haisu Xia"
output: pdf_document
date: "2024-12-8"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Get INDEL datasets from literature

This is to get the prepared dataset for further analysis provided by the reference. For more details see"Random Single Amino Acid Deletion Sampling Unveils Structural Tolerance and the Benefits of Helical Registry Shift on GFP Folding and Structure, DOI:10.1016/j.str.2014.03.014" and "Fitness Effects of Single Amino Acid Insertions and Deletions in TEM-1 β-Lactamase. DOI:10.1016/j.jmb.2019.04.030"
```{r Necessary packages}
library(readxl)
library(dplyr)
library(ggplot2)
library(bio3d)
library(seqinr)
library(grpreg)
library(glmnet)
library(glinternet)
```

```{r Prepare for dataset}

# Original TEM1-β protein sequence
tem_sequence <- "MSIQHFRVALIPFFAAFCLPVFAHPETLVKVKDAEDQLGARVGYIELDLNSGKILESFRPEERFPMMSTFKVLLCGAVLSRVDAGQEQLGRRIHYSQNDLVEYSPVTEKHLTDGMTVRELCSAAITMSDNTAANLLLTTIGGPKELTAFLHNMGDHVTRLDRWEPELNEAIPNDERDTTMPAAMATTLRKLLTGELLTLASRQQLIDWMEADKVAGPLLRSALPAGWFIADKSGAGERGSRGIIAALGPDGKPSRIVVIYTTGSQATMDERNRQIAEIGASLIKHW"

# Load Excel file
file_path <- "NIHMS1528810-supplement-1.xlsx"

# Load S1. Insertion Counts & Fitness data
s1_data <- read_excel(file_path, sheet = "S1. Insertion Counts & Fitness")

# Load S2. Deletion Counts & Fitness data
s2_data <- read_excel(file_path, sheet = "S2. Deletion Counts & Fitness")

# Function to process data
process_fitness_data <- function(data) {
  data %>%
    dplyr::filter(Fitness != "-") %>%                   # Remove "-" rows
    dplyr::mutate(Fitness = as.numeric(Fitness)) %>%   # Transfer to numeric value
    dplyr::group_by(`Ambler Position`) %>%
    dplyr::ungroup()
}

# Apply function to filter data
s1_filtered <- process_fitness_data(s1_data) %>%
  dplyr::rename(Pos = Position)

s2_filtered <- process_fitness_data(s2_data) %>%
  dplyr::rename(Pos = Position)

# Function to process S2 table "Deletion"
generate_variant_delete <- function(sequence, position) {
  before <- substr(sequence, 1, position - 1)
  after <- substr(sequence, position + 1, nchar(sequence))
  paste0(before, after)
}

# Function to process S1 table "Insertion"
generate_variant_insert <- function(sequence, position, inserted_aa) {
  before <- substr(sequence, 1, position)
  after <- substr(sequence, position + 1, nchar(sequence))
  paste0(before, inserted_aa, after)
}

# Generate Variant dataframe for deletions
variant_sequences_del <- s2_filtered %>%
  dplyr::mutate(
    Variant_Sequence = sapply(Pos, function(pos) generate_variant_delete(tem_sequence, pos)),
    InDel = "Del",
    AA = `WT AA`  # Get Deleted AA from dataframe
  ) %>%
  dplyr::select(Pos, Variant_Sequence, Fitness, InDel, AA)

# Generate Variant dataframe for insertions
variant_sequences_ins <- s1_filtered %>%
  dplyr::mutate(
    Variant_Sequence = mapply(generate_variant_insert, 
                            rep(list(tem_sequence), nrow(.)),
                            Pos,
                            `Inserted AA`),
    InDel = "In",
    AA = `Inserted AA`
  ) %>%
  dplyr::filter(AA == "A") %>%  
  dplyr::select(Pos, Variant_Sequence, Fitness, InDel, AA)

# Combine both datasets
variant_sequences <- rbind(variant_sequences_del, variant_sequences_ins)

write.csv(variant_sequences, "Variant_sequences.csv", row.names = FALSE)

```

```{r Statistical Calculation for Deleltion and Insertion}

variant_sequences <- read.csv("Variant_sequences.csv")

# Extracted deletion sequences and insertion sequences from variant_sequences.csv
del_variants <- variant_sequences %>%
  filter(InDel == "Del")
in_variants <- variant_sequences %>%
  filter(InDel == "In")

# calculate statistic value for deletion and insertion
aa_stats_del <- del_variants %>%
  group_by(AA) %>%
  summarise(
    mean_fitness = mean(Fitness),
    se_fitness = sd(Fitness)/sqrt(n()),
    n = n()
  )

aa_stats_in <- in_variants %>%
  group_by(AA) %>%
  summarise(
    mean_fitness = mean(Fitness),
    se_fitness = sd(Fitness)/sqrt(n()),
    n = n()
  )
```

```{r INDELi-e Analysis}
pdb_file <- "D:/Rdata/Bioinformatics_Project_1/1zg4.pdb"
stride_file <- "D:/Rdata/Bioinformatics_Project_1/STRIDE_1zg4.txt" 
read_pdb_file <- read.pdb(pdb_file, verbose=F)

## extract pdb info info into a df
extract_pdb_info<-function(x){
  x<-data.frame(x$atom)
  x<-x[,c(5:7)]
  x<- x %>% distinct(resno, chain, .keep_all=T)
  x$resid<-a(paste(substr(x$resid,1,1),
                   tolower(substr(x$resid,2,3)),
                   sep=""))
  
  x<-x[!is.na(x$resid),]
  return(x)
}

strucutre_info <- extract_pdb_info(read_pdb_file)

extract_stride_info <- function(stride_file) {
  # Load stride content
  stride_content <- readLines(stride_file)
  
  # filter ASG lines
  asg_lines <- grep("^ASG", stride_content, value = TRUE)
  
  # extract Structure line and ACC line
  stride_data <- data.frame(
    Structure = substr(asg_lines, 25, 25), 
    ACC = as.numeric(substr(asg_lines, 65, 71))
  )
  
  return(stride_data)
}


strucutre_info_2 <- extract_stride_info(stride_file)

### now merge pdb and stride info. 
strucutre_info_final <- bind_cols(strucutre_info, strucutre_info_2)

## rename resno to Pos
colnames(strucutre_info_final)[3] <- "Pos"

## add pdb_name column with your pdb identifier
strucutre_info_final$pdb_name <- "1zg4"

### Step 2: load the rSASA
# the df strucutre should be: "pdb_name", "Pos", "rSASA"
# make sure the "pdb_name" matches between strucutre_info_final and df_rsasa

## replace ".." with path to your rSASA folder
df_rsasa <- read.delim("D:/Rdata/Bioinformatics_Project_1/1zg4_rSASA.txt")

## make sure there is only one rSASA value per Pos!

##############################################################################
### Step 3: load the functions and run the structural encoding

## load functions "structural_features_data.R" and "encoded_data_for_predictor.R" located in the Functions folder
folder_location <- "D:/Rdata/Bioinformatics_Project_1/Functions"

script_files <- list.files(path = folder_location, pattern = "\\.R$", full.names = TRUE)

for (script_file in script_files) {
  source(script_file)
}

## run: structural_features_data.R (ignore warnings)
result <- tryCatch(
  structural_features_data(strucutre_info_final, df_rsasa),
  warning = function(w) {
    message("警告信息：", conditionMessage(w))
    return(NULL)
  },
  error = function(e) {
    message("错误信息：", conditionMessage(e))
    stop(e)
  }
)
# if you encounter errors here - please check your rSASA df: are pdb_names matching? Do you have one rSASA value per position?

##############################################################################
### Step 4: run the simplified structural encoding for INDELi and add ESM1v predictions

### now simplified encoding for predictor
result <- encoded_data_for_predictor(encoded_sec_struc)
simple_encoded_sec_struc <- result[[1]]

## add predictions; replace ".." with path to your esm1v prediction folder
# the df format should be "Pos", "esm1v" (the average substitution score per position)
esm1v_pred <- read.csv("D:/Rdata/Bioinformatics_Project_1/ESM1v_scores.txt", sep="")

# remember to reverse the esm1v score if needed. it has to match ddG (more negative=stable, more positive=unstable)
esm1v_pred$esm1v <- esm1v_pred$esm1v * -1

simple_encoded_sec_struc <- merge(simple_encoded_sec_struc, esm1v_pred[,c("Pos", "esm1v")])


##############################################################################
### Step 5: load the INDELi-E model (pre-trained) for predicting 1aa deletions, one-hot encode your data and save predictions

## load the pre-trained model
load("D:/Rdata/Bioinformatics_Project_1/INDELiE_deletions_model_pretrained.RData")


## one-hot encode your data
one_hot_encoded_df <- simple_encoded_sec_struc[,c(3:7,10:12)] %>%
  mutate(resid = as.factor(resid),
         simple_struc = as.factor(simple_struc),
         structure_before = as.factor(structure_before),
         structure_after = as.factor(structure_after),
         align_to_center = as.factor(align_to_center),
         align_to_center_termini = as.factor(align_to_center_termini),
         length = as.factor(length)) %>%
  model.matrix(~ . - 1, data = .)


## rename columns
result <- rename_columns(one_hot_encoded_df, simple_encoded_sec_struc)
one_hot_encoded_df <- result[[1]]

## you need to add any columns that are missing so the training df matches the one_hot_encoded_df columns.
missing<-names(pred_training[!(names(pred_training) %in% names(one_hot_encoded_df))])

for (o in missing){
  one_hot_encoded_df[[o]] <- 0
}

### run the predictions for 1aa deletions 
columns_to_include <- which(!names(one_hot_encoded_df) %in% c("ddG_ML_ins", "ddG_ML_subs"))

r_new<-model.matrix(fpred, model.frame(one_hot_encoded_df[,columns_to_include]))[,-1]
one_hot_encoded_df$predicted_INDELi<-predict(r_best_model_indeliE, s = r_best_lambda_indeliE, newx = r_new)

indeliE_dels<-data.frame(protein=one_hot_encoded_df$domain, Pos=one_hot_encoded_df$Pos, esm1v=one_hot_encoded_df$esm1v, INDELiE=one_hot_encoded_df$predicted_INDELi)

write.table(indeliE_dels, "D:/Rdata/Bioinformatics_Project_1/indeliE_dels.txt", row.names=F, quote=F)


##############################################################################
### Step 5: load the INDELi-E model (pre-trained) for predicting 1aa insertions

## load the pre-trained model.
load("D:/Rdata/Bioinformatics_Project_1/INDELiE_insertions_model_pretrained.RData")

### run the predictions for 1aa insertions
columns_to_include <- which(!names(one_hot_encoded_df) %in% c("ddG_ML_dels", "ddG_ML_subs"))

r_new<-model.matrix(fpred, model.frame(one_hot_encoded_df[,columns_to_include]))[,-1]
one_hot_encoded_df$predicted_INDELi<-predict(r_best_model_indeliE, s = r_best_lambda_indeliE, newx = r_new)

indeliE_ins<-data.frame(protein=one_hot_encoded_df$domain, Pos=one_hot_encoded_df$Pos, esm1v=one_hot_encoded_df$esm1v, INDELiE=one_hot_encoded_df$predicted_INDELi)

write.table(indeliE_ins, "D:/Rdata/Bioinformatics_Project_1/indeliE_ins.txt", row.names=F, quote=F)
```

```{r Plots for IndeliE benchmarking}

# Load experimental data
variant_sequences <- read.csv("Variant_sequences.csv")

# Extract deletion and insertion sequences
del_variants <- variant_sequences %>%
  filter(InDel == "Del")
in_variants <- variant_sequences %>%
  filter(InDel == "In")

# Load INDELi-E prediction results
deletions_path = "D:/Rdata/Bioinformatics_Project_1/indeliE_dels.txt"
insertions_path = "D:/Rdata/Bioinformatics_Project_1/indeliE_ins.txt"

deletions <- read.table(deletions_path, sep = " ", header = TRUE, fill = TRUE, blank.lines.skip = TRUE)
insertions <- read.table(insertions_path, sep = " ", header = TRUE, fill = TRUE, blank.lines.skip = TRUE)

# Combine experimental and prediction data
insertion_combined <- dplyr::inner_join(in_variants, insertions, by = "Pos")
deletion_combined <- dplyr::inner_join(del_variants, deletions, by = "Pos")

# For Deletions comparison plot
cor_value_del <- cor(deletion_combined$s1, deletion_combined$Fitness, method = "pearson")
lm_model_del <- lm(Fitness ~ s1, data = deletion_combined)

# Calculate additional metrics
mae_del <- mean(abs(lm_model_del$residuals))
rmse_del <- sqrt(mean(lm_model_del$residuals^2))
r2_del <- summary(lm_model_del)$r.squared

# Plot Fitness Value Comparison for Deletions
comparison <- ggplot(deletion_combined, aes(x = s1, y = Fitness)) +
  geom_point(color = "blue", size = 3) +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Fitness Value Comparison INDELi-E (Whole Sequence): Predicted Deletions vs Experimental Deletions",
       x = "Predicted Fitness (INDELi-E)",
       y = "Experimental Fitness") +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "white", color = "white"),
    plot.background = element_rect(fill = "white", color = "white"),
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  ) +
  annotate("text", 
           x = min(deletion_combined$s1), 
           y = max(deletion_combined$Fitness),
           label = sprintf("Pearson r = %.3f", cor_value_del),
           hjust = 0,
           vjust = 1,
           size = 4) +
  annotate("text", 
           x = min(deletion_combined$s1), 
           y = max(deletion_combined$Fitness) * 0.93,
           label = sprintf("MAE = %.3f", mae_del),
           hjust = 0,
           vjust = 1,
           size = 4) +
  annotate("text", 
           x = min(deletion_combined$s1), 
           y = max(deletion_combined$Fitness) * 0.86,
           label = sprintf("RMSE = %.3f", rmse_del),
           hjust = 0,
           vjust = 1,
           size = 4) +
  annotate("text", 
           x = min(deletion_combined$s1), 
           y = max(deletion_combined$Fitness) * 0.79,
           label = sprintf("R² = %.3f", r2_del),
           hjust = 0,
           vjust = 1,
           size = 4)

ggsave("plots/prediction_Experimental_Comparison_deletion_plot(Whole sequence).png", 
       comparison, width = 12, height = 8, dpi = 300)

print(comparison)

# For Insertions Comparison Plot
# 使用 s1 列而不是 INDELiE 列
cor_value_in <- cor(insertion_combined$s1, insertion_combined$Fitness, method = "pearson")
lm_model_in <- lm(Fitness ~ s1, data = insertion_combined)

# Calculate additional metrics
mae_in <- mean(abs(lm_model_in$residuals))
rmse_in <- sqrt(mean(lm_model_in$residuals^2))
r2_in <- summary(lm_model_in)$r.squared

comparison <- ggplot(insertion_combined, aes(x = s1, y = Fitness)) +
  geom_point(color = "blue", size = 3) +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Fitness Value Comparison INDELi-E (Whole Sequence): Predicted Insertions vs Experimental Insertions",
       x = "Predicted Fitness (INDELi-E)",
       y = "Experimental Fitness") +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "white", color = "white"),
    plot.background = element_rect(fill = "white", color = "white"),
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  ) +
  annotate("text", 
           x = min(insertion_combined$s1), 
           y = max(insertion_combined$Fitness),
           label = sprintf("Pearson r = %.3f", cor_value_in),
           hjust = 0,
           vjust = 1,
           size = 4) +
  annotate("text", 
           x = min(insertion_combined$s1), 
           y = max(insertion_combined$Fitness) * 0.93,
           label = sprintf("MAE = %.3f", mae_in),
           hjust = 0,
           vjust = 1,
           size = 4) +
  annotate("text", 
           x = min(insertion_combined$s1), 
           y = max(insertion_combined$Fitness) * 0.86,
           label = sprintf("RMSE = %.3f", rmse_in),
           hjust = 0,
           vjust = 1,
           size = 4) +
  annotate("text", 
           x = min(insertion_combined$s1), 
           y = max(insertion_combined$Fitness) * 0.79,
           label = sprintf("R² = %.3f", r2_in),
           hjust = 0,
           vjust = 1,
           size = 4)

ggsave("plots/prediction_Experimental_Comparison_insertion_plot(Whole sequence).png", 
       comparison, width = 12, height = 8, dpi = 300)

print(comparison)
```